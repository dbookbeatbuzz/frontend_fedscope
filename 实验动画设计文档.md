# 分簇‑FedSAK 联邦学习实验管理 **前端** 需求说明

> **适用范围**：基于现有 FederatedScope Web 前端（Vue 3 + Ant Design Vue）**实验管理 (Experiments)** 模块的功能增强；后端实现细节不在本文讨论范围，前端只依赖既定 REST / WebSocket 数据源。

---

## 1 项目目标

1. **可视化** 分簇联邦学习完整流程：客户端 → 簇内 FedAvg → 簇间 FedSAK → 循环。
2. **实时监控** 关键指标：FedAvg Loss、FedSAK 正则损失 𝓛\_r、Trace‑Rank、轮次进度、在线客户端数等。
3. **交互复现** 支持历史快照回放、节点日志溯源、算法公式解释。
4. **低学习成本** 任何未见过原示意图的研究者可通过界面快速理解系统运作。

---

## 2 逻辑流程与信息流（前端视角）

### 2.1 四层结构

| 层级 | 节点角色                        | 前端呈现     | 说明                       |
| -- | --------------------------- | -------- | ------------------------ |
| L3 | **FedSAK Aggregator**       | 单一顶部节点   | 收集簇模型、执行 FedSAK、下发 θ̃\_i |
| L2 | **Cluster Proxy (i = 1…K)** | 同行 K 个节点 | 向簇内广播模型、做簇内 FedAvg       |
| L1 | **Client Cluster 𝒞ᵢ**      | 虚线分组框    | 由聚类算法划分，缓解特征异构           |
| L0 | **Client c ∈ 𝒞ᵢ**          | 多个末端节点   | 本地 SGD 训练，上传 θ\_c        |

> **拓扑动画**：节点按层横向排列，边从上到下；聚类完成后非本簇连线淡出，以突出 "全→簇→客户端" 关系。

### 2.2 单轮时序（三阶段）

```mermaid
sequenceDiagram
  participant S as Aggregator (L3)
  participant P as Proxy i (L2)
  participant C as Client c (L0)
  Note over S,P,C: ❶ 模型下发
  S->>P: θ̃_i^(t)
  P->>C: θ̃_i^(t)
  Note over C: 本地训练 E epoch
  Note over S,P,C: ❷ 簇内聚合
  C-->>P: θ_c^(t)
  P->>P: FedAvg → θ_i^(t+1)
  Note over S,P,C: ❸ 簇间聚合
  P-->>S: θ_i^(t+1)
  S->>S: FedSAK → θ̃_i^(t+1)
  S-->>P: 广播 θ̃_i^(t+1)
```

### 2.3 关键公式（界面 Tooltip 弹窗展示）

#### 簇内 FedAvg

$$
\theta_i^{(t+1)}
= \sum_{c \in \mathcal{C}_i} \frac{n_c}{N_i}\,\theta_c^{(t)}, 
\qquad
N_i = \sum_{c \in \mathcal{C}_i} n_c
$$

---

#### 簇间 FedSAK

1. **张量堆叠**
   对第 $l$ 层，将各簇模型参数堆叠成 $p$ 阶张量：

   $$
   W^{(l)} \;=\; \mathrm{stack}\bigl(\theta_1^{(l)},\,\theta_2^{(l)},\,\dots,\,\theta_K^{(l)}\bigr)
   $$

2. **轨迹范数正则化损失**

   $$
   \mathcal{L}_r
   = \lambda \sum_{l=1}^{L} \sum_{k=1}^{p} \bigl\|\,W_{(k)}^{(l)}\bigr\|_{*}
   $$

   其中 $W\_{(k)}^{(l)}$ 表示对 $W^{(l)}$ 按第 $k$ 模展开得到的矩阵，$|\cdot|_*$ 为核范数。

3. **SVD 分解**

   $$
   W_{(k)}^{(l)} = U_k\,\Sigma_k\,V_k^{\top}
   $$

4. **子梯度**

   $$
   \nabla_{W_{(k)}^{(l)}} \bigl\|W_{(k)}^{(l)}\bigr\|_{*}
   = U_k\,V_k^{\top}
   $$

5. **切片映射**
   将所有模式的子梯度累加后，取第 $i$ 簇对应切片：

   $$
   G_i^{(l)}
   = \mathrm{slice}_i\Bigl(\sum_{k=1}^{p} U_k\,V_k^{\top}\Bigr)
   $$

6. **参数更新**

   $$
   \theta_i^{(l)} 
   \;\leftarrow\; 
   \theta_i^{(l)} - \eta_w \, G_i^{(l)}
   $$

---

#### 符号释义

* $L$：模型总层数
* $p$：张量阶数（层参数展成张量后的阶数）
* $K$：簇的数量
* $\theta\_c^{(t)}$：客户端 $c$ 在轮次 $t$ 时的模型参数
* $\theta\_i^{(l)}$：第 $i$ 簇模型在第 $l$ 层的参数
* $n\_c$：客户端 $c$ 的数据量
* $N\_i$：簇 $\mathcal{C}\_i$ 中所有客户端总样本数
* $\lambda$：轨迹范数正则化系数
* $\eta\_w$：簇间聚合的学习率
* $W^{(l)}$：第 $l$ 层簇模型参数堆叠张量
* $W\_{(k)}^{(l)}$：按第 $k$ 模展开后的矩阵形式
* $U\_k,\Sigma\_k,V\_k$：$W\_{(k)}^{(l)}$ 的 SVD 分解结果
* $G\_i^{(l)}$：第 $i$ 簇在第 $l$ 层对应的子梯度切片
* $|\cdot|_*$：矩阵核范数（trace norm）
* $\mathrm{slice}\_i(\cdot)$：取张量在“簇”维度上第 $i$ 个索引对应切片
* $\mathrm{stack}(\cdot)$：沿新维度将向量/矩阵堆叠为张量

---

## 3 界面信息架构

### 3.1 新增页签位置

```
ExperimentDetail
 ├─ Overview | Metrics | **Cluster‑FedSAK** | Logs
```

### 3.2 页面布局

```
┌──────────────────────────────────────────┐
│ Tab Bar                                   │
├──────────────────────────────────────────┤
│ 左列 TopologyCard  (60%)  │ 右上 ProgressPanel (20%) │
│  ‑ 交互式四层图             │  ‑ 轮次进度条            │
│  ‑ 节点着色/点击日志         │  ‑ 统计: 在线/簇数       │
│──────────────────────────────────────────│
│ 右下 MetricsTabs (20%)                    │
│  ‑ 折线: Loss_FedAvg, 𝓛_r, Rank          │
└──────────────────────────────────────────┘
```

### 3.3 核心组件

| 组件                       | 库                                       | 交互要点                          |
| ------------------------ | --------------------------------------- | ----------------------------- |
| **TopologyCard**         | `@antv/g6` 或 ECharts graph              | 支持拖拽放大、节点点击弹日志、边高亮路径          |
| **ProgressPanel**        | `a-card` + `a-progress` + `a-statistic` | 实时显示当前 round / total、在线客户端、簇数 |
| **MetricsTabs**          | ECharts line                            | 曲线可切面积/折线；支持暂停、区间缩放           |
| **FormulaModal**         | `a-modal`                               | Σ 图标触发，列出两条公式与符号释义、λ、η\_w 当前值 |
| **ClusterMapTable** (可选) | `a-table`                               | 客户端→簇 映射，支持搜索过滤               |

---

## 4 数据接口（前端依赖）

| 方法    | 路径                                   | 说明                                                                                       |
| ----- | ------------------------------------ | ---------------------------------------------------------------------------------------- |
| `GET` | `/experiments/{id}/clusters`         | 返回拓扑结构 `{clusters:[{id, clients:[…]}]}`                                                  |
| `WS`  | `/experiments/{id}/fedsak/stream`    | 推流 `{round, loss_fedavg, loss_fedsak, trace_rank, clusters:[{id,size,online,avg_loss}]}` |
| `GET` | `/experiments/{id}/snapshot/{round}` | 回放同格式静态数据                                                                                |

---

## 5 实验创建表单扩展

| 字段             | 类型     | 默认      | 说明                                   |
| -------------- | ------ | ------- | ------------------------------------ |
| `cluster_algo` | Select | K‑means | 聚类算法选项 (K‑means / Spectral / DBSCAN) |
| `num_clusters` | Number | 4       | 预期簇数 K                               |
| `lambda_trace` | Float  | 1e‑3    | FedSAK 正则 λ                          |
| `eta_w`        | Float  | 0.1     | FedSAK 步长 η\_w                       |

表单校验：`num_clusters > 1`；`λ, η_w` ≥ 0。

---

## 6 交互流程

1. **实时监控**：页面挂载后订阅 WebSocket → 更新拓扑节点状态与指标折线。
2. **公式学习**：点击 Σ 图标 → `FormulaModal` 打开；支持复制公式。
3. **历史回放**：在 ProgressPanel 选择轮次 → 调 `/snapshot/{round}` → 重绘拓扑+曲线。
4. **节点日志**：TopologyCard 节点点击 → 侧边抽屉显示 `{stdout, stderr}` 日志摘要 (由现有日志接口提供)。

---

## 7 性能与兼容性

| 目标     | 指标                                      |
| ------ | --------------------------------------- |
| 图形 FPS | 节点 ≤ 300 时 ≥ 30 FPS                     |
| 曲线性能   | 单次增量 ≤ 200 点，自动 decimation              |
| 浏览器    | Chrome / Edge ≥ 102 (桌面)；移动端降级为 SVG 静态图 |

---

## 8 术语表

| 术语                      | 含义                                                           |
| ----------------------- | ------------------------------------------------------------ |
| **FedAvg**              | Federated Averaging：簇/客户端加权平均                                |
| **FedSAK**              | Federated Subspace Alignment via Tucker‑trace regularization |
| **Trace‑Rank**          | \(\text{rank}(W^{l})\) 估计，用于监控低秩程度                           |
| **θ\_c / θ\_i / θ̃\_i** | 客户端模型 / 簇模型 / FedSAK 更新后模型                                   |

---

> **完成**：本需求文档完整整合了两轮讨论内容，聚焦前端视图、交互与数据依赖，供 UI/UX 与前端开发直接实施。

