# 模型测试功能设计（前后端联动方案）

## 目标与范围
- 将“下载模型”按钮改为“测试模型”。
- 点击后弹出一个测试弹窗：从测试集中抽取一部分样本，由后端执行评测；前端接收测试过程与结果并可视化展示。
- 在弹窗中展示：整体准确率、样本级详情（输入内容、期望/标签、模型输出、是否正确）、进度与耗时。
- 同时支持文本与图像输入（如 ResNet、ViT 等图像分类模型）在同一套机制下工作。
- 设计接口契约、前端组件与状态机，确保易于联调与扩展。

## 需求清单（Checklist）
- [ ] UI：Models 页面中卡片四个功能键之一改为“测试模型”（替换原“下载模型”）
- [ ] 弹窗：包含抽样参数（样本数/比例、随机种子等）、开始测试、进度、取消按钮
- [ ] 后端：提供开始测试、流式推送样本结果、总结/统计、取消测试的接口
- [ ] 前端：累积样本结果，计算准确率，列表展示各样本输入与模型输出
- [ ] 错误处理：请求失败、连接中断、超时、后台报错
- [ ] 性能：大样本时分页/虚拟列表、增量渲染、限流

## 端到端交互流程（时序）
1. 用户点击“测试模型”按钮 → 打开弹窗。
2. 用户配置参数（默认给定合理值）→ 点击“开始测试”。
3. 前端 POST 启动测试 → 后端返回 jobId。
4. 前端基于 jobId 建立事件流（SSE）或 WebSocket 订阅，实时接收：
   - progress 更新（已处理样本数/总数）
   - case 级结果（输入、标签、输出、是否正确）
   - summary 统计（accuracy、耗时等）
5. 前端累积数据并更新 UI；支持“取消测试”与失败重试。
6. 测试完成，弹窗保持可查看与导出（可选）；用户关闭弹窗。

## 后端接口契约（建议）
为兼顾易实现和实时性，优先采用 SSE（Server-Sent Events）；如已有 WS 基础，也可替换为 WebSocket。

### 1) 启动测试
- Method: POST
- URL: `/api/models/{modelId}/test`
- Body (JSON)：
  ```json
  {
    "sampleCount": 100,
    "sampleRatio": null,
    "randomSeed": 42,
    "filters": { "label": ["classA", "classB"] }
  }
  ```
  说明：`sampleCount` 与 `sampleRatio` 二选一，皆为空则由后端给默认值。
- Response (201)：
  ```json
  { "jobId": "test_20250811_abcdef", "total": 100 }
  ```

### 2) 结果流（SSE）
- Method: GET
- URL: `/api/models/tests/{jobId}/stream`
- Header: `Accept: text/event-stream`
- Events：
  - `progress`：
    ```json
    { "processed": 25, "total": 100, "elapsedMs": 1320 }
    ```
  - `case`（文本示例）：
    ```json
    {
      "caseId": "idx_00025",
      "input": { "type": "text", "text": "...或结构化字段" },
      "label": "classA",
      "output": { "predLabel": "classA", "topK": [{"label": "classA", "prob": 0.91}] },
      "correct": true,
      "latencyMs": 48
    }
    ```
  - `case`（图像示例，推荐 URL 引用）：
    ```json
    {
      "caseId": "img_00025",
      "input": {
        "type": "image",
        "url": "/static/datasets/imagenet/img_00025.jpg",
        "mime": "image/jpeg",
        "width": 640,
        "height": 480
      },
      "label": "tabby_cat",
      "output": {
        "predLabel": "tabby_cat",
        "topK": [
          { "label": "tabby_cat", "prob": 0.83 },
          { "label": "tiger_cat", "prob": 0.12 },
          { "label": "Egyptian_cat", "prob": 0.03 }
        ]
      },
      "correct": true,
      "latencyMs": 52
    }
    ```
    说明：
    - SSE/WS 不适合传输二进制大对象，图像推荐以可访问的 URL 引用（同域或允许 CORS）。
    - 小图/演示可选用 `dataUrl` 但不建议在大规模样本中使用。
  - `summary`：
    ```json
    {
      "accuracy": 0.87,
      "processed": 100,
      "total": 100,
      "confusionMatrix": { "classA": {"TP": 10, "FP": 2, "FN": 1}, "classB": {"TP": 20, ...} },
      "startedAt": "2025-08-11T01:02:03Z",
      "finishedAt": "2025-08-11T01:05:01Z"
    }
    ```
  - `error`：
    ```json
    { "code": "INTERNAL_ERROR", "message": "detail..." }
    ```
  说明：`case` 事件可以大量发送；`summary` 至少一次（结束时）。

### 3) 取消测试
- Method: POST
- URL: `/api/models/tests/{jobId}/cancel`
- Response: 200 `{ "cancelled": true }`

> WebSocket 方案可将上述事件以 message.type = progress|case|summary|error 推送，payload 同上。

### 图像资源服务要求（建议）
- 图像应通过静态资源或受控下载接口提供，如 `/static/...` 或 `/api/files/{id}`。
- 保证跨域访问头（CORS）正确，前端可直接以 `<img src="..."/>` 访问。
- 大图建议支持缩略图 URL 与原图 URL（缩略图优先展示，点击预览原图）。

### 可选：样本详情拉取
若单条样本包含较大载荷，可在 `case` 事件中仅推送轻量字段：`{caseId, label, output, correct}`，然后前端在需要展示时调用：
- `GET /api/models/tests/{jobId}/cases/{caseId}` → 返回 `{ input: {type, url|dataUrl|text, ...} }`
用于惰性加载图像输入，减轻流式事件压力。

## 前端数据结构（建议）
```ts
// 以 JS 项目为主，可用 JSDoc 注解或在注释中标注类型
/** @typedef {{
 *  type: 'text'|'image'|'json',
 *  // 文本
 *  text?: string,
 *  // 图像（推荐 URL；小图可 dataUrl）
 *  url?: string,
 *  dataUrl?: string,
 *  mime?: string,
 *  width?: number,
 *  height?: number,
 *  // 其他结构化输入
 *  payload?: any
 * }} TestInput
 */

/** @typedef {{ label: string|number, prob: number }} TopKItem */

/** @typedef {{
 *  // 统一输出结构，分类任务示例
 *  predLabel?: string|number,
 *  topK?: TopKItem[],
 *  raw?: any
 * }} TestOutput
 */

/** @typedef {{
 *  caseId: string,
 *  input: TestInput,
 *  label?: string | number,
 *  output: TestOutput,
 *  correct?: boolean,
 *  latencyMs?: number
 * }} TestCaseResult
 */

/** @typedef {{
 *  accuracy?: number,
 *  processed: number,
 *  total?: number,
 *  startedAt?: string,
 *  finishedAt?: string
 * }} TestSummary
 */

/** @typedef {{
 *  jobId: string,
 *  modelId: string|number,
 *  params: { sampleCount?: number, sampleRatio?: number, randomSeed?: number, filters?: any },
 *  cases: TestCaseResult[],
 *  summary: TestSummary,
 *  status: 'idle'|'running'|'success'|'error'|'cancelled',
 *  error?: { code?: string, message: string }
 * }} ModelTestSession
 */
```

## 前端组件设计
### 一、UI 改造点（Models.vue）
- 将“下载模型”按钮改为“测试模型”。
- 点击后打开测试弹窗，传入 `modelId` 和可选 `modelName`。

伪代码：
```vue
<!-- Models.vue 片段 -->
<template>
  <!-- ...模型卡片... -->
  <button @click="openTestDialog(model.id, model.name)">测试模型</button>
  <ModelTestDialog
    :visible="testDialog.visible"
    :model-id="testDialog.modelId"
    :model-name="testDialog.modelName"
    @close="testDialog.visible=false"
  />
</template>

<script>
import ModelTestDialog from '@/components/ModelTestDialog.vue'
export default {
  components: { ModelTestDialog },
  data(){
    return { testDialog: { visible: false, modelId: null, modelName: '' } }
  },
  methods:{
    openTestDialog(id, name){
      this.testDialog = { visible: true, modelId: id, modelName: name }
    }
  }
}
</script>
```

### 二、弹窗组件（components/ModelTestDialog.vue）
- Props：
  - `visible: Boolean` 控制显示
  - `modelId: String|Number`
  - `modelName?: String`
- Emits：`close`
- 区块：
  - 参数面板：样本数/比例、随机种子、筛选项、开始测试按钮
  - 进度与汇总：进度条、已处理/总数、准确率（Top-1，选配 Top-5）、耗时
  - 结果列表：
    - 文本样本：表格/列表展示输入文本摘要、标签、模型输出与正确标记
    - 图像样本：缩略图网格或含图列模式，展示：缩略图、标签、Top-K 预测（标签+概率）、是否正确
    - 支持分页/虚拟滚动；图像支持点击弹出大图预览（可放大/缩放/拖动）
  - 底部操作：取消测试、清空结果、关闭
- 行为：
  - 点击“开始测试”→ 调用启动接口 → 建立 SSE 订阅 → 实时写入列表与汇总
  - 点击“取消测试”→ 调用取消接口 → 关闭流与状态标记
  - 关闭弹窗自动清理连接

渲染要点：
- 初始状态：仅显示参数表单与“开始测试”。
- running：禁用参数表单；显示进度条与实时准确率（correct/processed，Top-1）。
- success：显示 summary 与导出/复制（可选）。
- error/cancelled：顶部醒目提示，允许重新开始。

图像展示要点：
- 使用缩略图优先策略，缩略图加载失败回退至占位图并提供重试。
- 列表惰性加载可视区域内的图像；限制并发请求数（如 4-6）。
- 超长列表开启虚拟滚动，回收不在视区的 DOM 和对象 URL。
- 点击缩略图打开预览层，预览时再加载原图 URL。

## 前端逻辑与状态机
- 状态：`idle → running → success | error | cancelled`
- 事件：
  - start(jobId,total) → running
  - case(result) → 累积 cases，更新 processed、correct 计数、实时 accuracy
  - progress(processed,total) → 更新进度（在未收到 case 时也可更新条形图）
  - summary(accuracy, finishedAt) → success
  - cancel() → cancelled
  - error(e) → error

准确率计算：
```
accuracy = (correctCount / processed)（流式实时）
最终以 summary.accuracy 为准（若后端提供）
```

Top-K（图像分类常用）：
```
top1Correct += (output.predLabel === label) ? 1 : 0
// 若提供 topK，则还可统计 top5Correct
top5Correct += output.topK?.some(x => x.label === label) ? 1 : 0
top1 = top1Correct / processed
top5 = top5Correct / processed
```

## API 访问封装（建议）
新建 `src/api/test.js`：
- `startModelTest(modelId, params) => Promise<{jobId,total}>`
- `openTestStream(jobId, handlers) => close()` 使用 EventSource：
  - handlers: `{ onProgress, onCase, onSummary, onError }`
- `cancelModelTest(jobId)`

错误与重试：
- 启动失败：在 UI 显示错误，允许修改参数重试。
- 流断开：在 running 状态下提示“连接中断，尝试重连”，并提供“手动重连/结束测试”。是否自动重连由后端是否保留 job 缓冲决定。

## 性能与可用性
- 大样本：采用分页或虚拟列表（仅渲染可见行），限制前端内存。
- 限流渲染：大量 case 事件下，使用 requestAnimationFrame 或批次合并更新，避免频繁重排。
- 文本溢出与可读性：长文本折叠/展开；JSON 输入支持格式化查看。
- 图像优化：
  - 缩略图/原图分离，懒加载与占位骨架；并发上限与失败重试（指数退避）。
  - 使用浏览器缓存与 ETag；必要时在 URL 上携带版本戳避免脏缓存。
  - 对 dataUrl/Blob URL 谨慎使用，使用完及时 `URL.revokeObjectURL` 释放内存。
  - CSS object-fit: cover 控制缩略图裁剪，固定容器大小保持布局稳定。

## 可选增强
- 导出 CSV/JSON（仅在成功或部分完成时）
- 混淆矩阵/PR 曲线可视化（若后端提供）
- 支持回放：通过 jobId 再次拉取历史结果（需要后端存档）
- 图像 Lightbox/预览增强：旋转、缩放手势、键盘导航
- 类别搜索与筛选（长尾类别定位）

## 联调清单
- [ ] 成功发起测试并获取 jobId
- [ ] 能收到 progress、case、summary 事件
- [ ] 实时准确率与最终准确率一致
- [ ] 取消后不再有新事件，状态为 cancelled
- [ ] 异常时 UI 有错误提示并可重试
- [ ] 图像样本缩略图可正常显示（含跨域/CORS 验证）
- [ ] Top-K 显示与统计（若后端提供 topK）
- [ ] 缩略图点击可预览原图；加载失败有占位与重试
- [ ] 大样本下滚动流畅，内存无明显上涨

## 验收标准
- Models 页面上“测试模型”按钮正确显示并能打开弹窗。
- 默认参数可直接跑一轮小样本测试（例如 50 条），实时显示进度与样本详情。
- 测试完成后显示准确率、总数、耗时；每个样本显示输入、标签、输出、正确与否。
- 取消测试行为生效，网络错误有提示。
- 图像输入：缩略图渲染稳定，点击可预览原图；Top-1 准确率正确，若提供 Top-5 则同步展示与统计。

## 实施步骤（前端）
1. 更新 `src/views/Models.vue`：替换按钮文本/事件，挂载 `ModelTestDialog`。
2. 新增 `src/components/ModelTestDialog.vue`：完成 UI 与状态机。
3. 新增 `src/api/test.js`：封装启动、SSE、取消三个调用。
4. 样式与性能优化：分页/虚拟列表（如使用简单自研虚拟滚动或轻量库）；图像缩略图网格样式与预览层。
5. 联调并完善错误处理与边界情况。

## 实施步骤（后端参考）
1. 新增 `POST /api/models/{modelId}/test` 启动测试，返回 jobId/total。
2. 新增 `GET /api/models/tests/{jobId}/stream` 推送 progress/case/summary/error（SSE）。
3. 新增 `POST /api/models/tests/{jobId}/cancel` 取消任务。
4. 确保任务生命周期管理与清理（超时/断连）。
5. 图像资源：提供稳定可访问的静态路径或文件下载接口；同域优先，或配置允许的 CORS；可选缩略图生成。

---
如需，我可基于本文档直接提交前端代码骨架（含弹窗组件与 API 封装），便于后端对照对接。
