# 🎯 分簇‑FedSAK 实验动画可视化设计（Cytoscape.js + Vue 版）

---

## 🧭 1. 目标集成

| 原设计文档目标编号 | 说明                   | Cytoscape.js 实现策略                   |
| --------- | -------------------- | ----------------------------------- |
| **1**     | 分层拓扑图（L3→L2→L1→L0）   | 使用 concentric 布局 + compound nodes   |
| **2**     | 展示指标 Loss、Trace-Rank | 不变，由右下 MetricsTab 呈现                |
| **3**     | 节点日志、公式 Tooltip、回放   | 节点点击事件 + Modal 弹窗；回放机制通过 props 驱动重绘 |
| **4**     | 无需了解原理即可快速理解拓扑和流程    | 自动布局、动态动画呈现训练路径、簇内外视觉区分             |

---

## 🧱 2. 四层结构实现方式

| 层级 | 实体                | Cytoscape 映射         | 动画支持             |
| -- | ----------------- | -------------------- | ---------------- |
| L3 | FedSAK Aggregator | 顶层单节点                | 可缩放高亮，表示轮次更新     |
| L2 | Proxy（簇）          | 子图节点 + compound node | 外框虚线包围，聚合内层客户端   |
| L1 | Cluster 𝒞ᵢ       | compound group       | 淡出非本簇连线、hover 突出 |
| L0 | Client c          | 叶子节点                 | 动画变色、尺寸、连线       |

---

## 🗺️ 3. 布局设计：concentric layout

```ts
layout: {
  name: 'concentric',
  concentric: node => {
    const layer = node.data('layer')
    return layer === 'L3' ? 4 : layer === 'L2' ? 3 : layer === 'L1' ? 2 : 1
  },
  levelWidth: () => 1,
  animate: true,
  fit: true,
  padding: 50
}
```

* L3 在最中心，L2 簇外围排布，L1 客户端分组居外，L0 节点自动包裹于 cluster 内。
* 簇节点作为 `compound node`，L0 节点设定 `parent: clusterId`。

---

## 🎨 4. 样式规则（Style Sheet）

```ts
style: [
  {
    selector: 'node',
    style: {
      'background-color': '#7f8c8d',
      'label': 'data(label)',
      'text-valign': 'center',
      'color': '#fff',
      'width': 40,
      'height': 40
    }
  },
  {
    selector: 'node[layer="L3"]',
    style: { 'background-color': '#2c3e50', 'shape': 'hexagon' }
  },
  {
    selector: 'node[layer="L2"]',
    style: {
      'background-color': '#e67e22',
      'shape': 'ellipse',
      'border-style': 'solid',
      'border-color': '#d35400'
    }
  },
  {
    selector: 'node[layer="L1"]',
    style: {
      'background-color': '#2980b9',
      'parent': 'data(cluster)',
      'shape': 'ellipse'
    }
  },
  {
    selector: 'node[layer="L0"]',
    style: {
      'background-color': '#27ae60',
      'width': 30,
      'height': 30
    }
  },
  {
    selector: 'node[parent]',
    style: {
      'background-opacity': 0.05,
      'border-style': 'dashed',
      'border-color': '#34495e',
      'padding': '20px'
    }
  },
  {
    selector: 'edge',
    style: {
      'line-color': '#95a5a6',
      'target-arrow-shape': 'triangle',
      'target-arrow-color': '#95a5a6',
      'width': 2
    }
  }
]
```

---

## 🔁 5. 动画流程设计

### 5.1 动画入口

```ts
watch(() => props.activeClients, newVal => {
  highlightClients(newVal)
})
```

### 5.2 训练动画逻辑

```ts
function highlightClients(clientIds: string[]) {
  clientIds.forEach(id => {
    const node = cy.getElementById(id)
    node.animate({
      style: { 'background-color': '#16a085', 'width': 50 }
    }, {
      duration: 300
    })
    cy.add({ data: { source: id, target: 'proxy-i' }, group: 'edges' })
  })
}
```

### 5.3 簇内聚合动画（FedAvg）

* L0 → L2 连线动画（淡入 → 消失）
* L2 节点短暂放大表示“聚合中”

### 5.4 簇间聚合动画（FedSAK）

* L2 → L3 路径高亮；
* L3 节点震动表示共享层优化完成；
* 可附加 trace-rank 更新动态数字标签。

---

## 🧩 6. 组件集成结构

```vue
<template>
  <div class="cluster-topology">
    <CytoscapeGraph
      :nodes="nodes"
      :edges="edges"
      :activeClients="activeClients"
      :layoutType="'concentric'"
    />
    <ProgressPanel :round="round" :total="total" />
    <MetricsTabs :metrics="metricData" />
    <FormulaModal v-if="showModal" :formulas="..." />
  </div>
</template>
```

---

## 📦 7. 数据流与接口映射

| 前端行为    | 对应接口                                       | 说明             |
| ------- | ------------------------------------------ | -------------- |
| 实时更新    | WebSocket `/experiments/:id/fedsak/stream` | 更新拓扑结构 / 节点状态  |
| 回放某轮    | GET `/experiments/:id/snapshot/:round`     | 加载某轮的拓扑和指标     |
| 拓扑结构初始化 | GET `/experiments/:id/clusters`            | 初始化簇、节点分组结构    |
| 动画驱动数据源 | props.activeClients / metricData           | 父组件传入控制动画与指标展示 |

---

## 📐 8. UI 结构（对照原文档）

已完美对接原文档中布局：

* 左主图：用 Cytoscape 实现 `TopologyCard`
* 右侧上方：轮次进度与指标概览（`ProgressPanel`）
* 右下：折线图表区（`MetricsTabs`）
* 弹窗：公式详情（`FormulaModal`）

---

## ✅ 9. 优势总结（对比 ECharts）

| 功能             | ECharts 现状 | Cytoscape 优势              |
| -------------- | ---------- | ------------------------- |
| 节点布局           | 手动坐标       | 自动 concentric / dagre 等支持 |
| 聚类可视化          | 无法表达“域”    | compound node 可框选 L2 层域结构 |
| 客户端选中动态        | 需改线条模拟     | 支持颜色/尺寸/路径等粒度动画           |
| 算法过程动画         | 难以实现       | 支持 animate() 任意属性变更       |
| 节点拖拽、hover、日志等 | 无原生支持      | 全面支持交互操作事件监听              |

